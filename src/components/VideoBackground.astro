---
/**
 * Full-screen looping background video
 * - Muted for autoplay compliance
 * - Positioned behind all content
 * - Subtle overlay for text readability
 * - Robust mobile playback with auto-resume
 */
---

<div class="fixed inset-0 -z-10 overflow-hidden">
  <!-- Video element -->
  <video
    id="bg-video"
    class="absolute inset-0 w-full h-full object-cover"
    autoplay
    loop
    muted
    playsinline
    preload="auto"
    poster="/poster.jpg"
    webkit-playsinline="true"
    x5-playsinline="true"
    x5-video-player-type="h5"
    x5-video-player-fullscreen="true"
  >
    <source src="https://firebasestorage.googleapis.com/v0/b/mesmer-hypnosis-tt2hj3.firebasestorage.app/o/mesmerweb%2FWebsite%20rain.mp4?alt=media&token=2b277dba-bdf0-4fd4-bada-e0516550f527" type="video/mp4" />
  </video>

  <!-- Dark overlay for text contrast -->
  <div class="absolute inset-0 bg-dark-900/60"></div>

  <!-- Subtle gradient fade at bottom -->
  <div class="absolute inset-x-0 bottom-0 h-48 bg-gradient-to-t from-dark-900 to-transparent"></div>
</div>

<script>
  const video = document.getElementById('bg-video') as HTMLVideoElement;

  // Ensure video stays playing on mobile
  function tryPlay() {
    if (video.paused) {
      video.play().catch(() => {
        // Silently fail - poster will show as fallback
      });
    }
  }

  // Resume when page becomes visible again
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      tryPlay();
    }
  });

  // Resume on any user interaction (helps with strict mobile policies)
  const resumeOnInteraction = () => {
    tryPlay();
    // Remove listeners after first successful interaction
    document.removeEventListener('touchstart', resumeOnInteraction);
    document.removeEventListener('click', resumeOnInteraction);
    document.removeEventListener('scroll', resumeOnInteraction);
  };
  document.addEventListener('touchstart', resumeOnInteraction, { passive: true });
  document.addEventListener('click', resumeOnInteraction);
  document.addEventListener('scroll', resumeOnInteraction, { passive: true });

  // Detect if video stalls and restart it
  video.addEventListener('pause', () => {
    // Only auto-resume if we didn't intentionally pause
    // Background videos should always play
    setTimeout(tryPlay, 100);
  });

  // Handle video stall/waiting states
  video.addEventListener('waiting', () => {
    // Video is buffering - will auto-resume when ready
  });

  video.addEventListener('stalled', () => {
    // Try to recover from stall
    setTimeout(() => {
      video.load();
      tryPlay();
    }, 1000);
  });

  // Initial play attempt
  tryPlay();
</script>

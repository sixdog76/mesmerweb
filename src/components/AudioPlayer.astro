---
/**
 * Custom styled HTML5 audio player
 * - Does NOT autoplay
 * - Dispatches 'audioEnded' event when complete
 * - Minimal, matte design
 */
---

<div class="w-full max-w-md mx-auto">
  <audio
    id="audio-player"
    class="w-full"
    preload="metadata"
  >
    <source src="/audio.mp3" type="audio/mpeg" />
    Your browser does not support the audio element.
  </audio>

  <!-- Custom player UI -->
  <div class="bg-dark-700/80 backdrop-blur-sm rounded-lg p-5 border border-cream-100/10">
    <!-- Play/Pause button and progress -->
    <div class="flex items-center gap-4">
      <button
        id="play-btn"
        type="button"
        class="w-12 h-12 flex items-center justify-center rounded-full bg-accent/20 hover:bg-accent/30 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-accent/50"
        aria-label="Play audio"
      >
        <svg id="play-icon" class="w-5 h-5 text-cream-100 ml-0.5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
        <svg id="pause-icon" class="w-5 h-5 text-cream-100 hidden" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </svg>
      </button>

      <!-- Progress bar -->
      <div class="flex-1">
        <div
          id="progress-container"
          class="h-1.5 bg-dark-800 rounded-full cursor-pointer overflow-hidden"
          role="slider"
          aria-label="Audio progress"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="0"
        >
          <div id="progress-bar" class="h-full bg-accent rounded-full w-0 transition-all duration-100"></div>
        </div>
        <div class="flex justify-between mt-2 text-xs text-cream-300">
          <span id="current-time">0:00</span>
          <span id="duration">0:00</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const audio = document.getElementById('audio-player') as HTMLAudioElement;
  const playBtn = document.getElementById('play-btn') as HTMLButtonElement;
  const playIcon = document.getElementById('play-icon') as SVGElement;
  const pauseIcon = document.getElementById('pause-icon') as SVGElement;
  const progressBar = document.getElementById('progress-bar') as HTMLDivElement;
  const progressContainer = document.getElementById('progress-container') as HTMLDivElement;
  const currentTimeEl = document.getElementById('current-time') as HTMLSpanElement;
  const durationEl = document.getElementById('duration') as HTMLSpanElement;

  // Format time as M:SS
  function formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // Update play/pause icons
  function updatePlayState(playing: boolean) {
    playIcon.classList.toggle('hidden', playing);
    pauseIcon.classList.toggle('hidden', !playing);
    playBtn.setAttribute('aria-label', playing ? 'Pause audio' : 'Play audio');
  }

  // Play/pause toggle
  playBtn.addEventListener('click', () => {
    if (audio.paused) {
      audio.play();
    } else {
      audio.pause();
    }
  });

  audio.addEventListener('play', () => updatePlayState(true));
  audio.addEventListener('pause', () => updatePlayState(false));

  // Update progress
  audio.addEventListener('timeupdate', () => {
    const percent = (audio.currentTime / audio.duration) * 100;
    progressBar.style.width = `${percent}%`;
    currentTimeEl.textContent = formatTime(audio.currentTime);
  });

  // Set duration when loaded
  audio.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(audio.duration);
  });

  // Click to seek
  progressContainer.addEventListener('click', (e) => {
    const rect = progressContainer.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    audio.currentTime = percent * audio.duration;
  });

  // Dispatch custom event when audio ends
  audio.addEventListener('ended', () => {
    updatePlayState(false);
    window.dispatchEvent(new CustomEvent('audioEnded'));
  });
</script>

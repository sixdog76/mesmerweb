---
/**
 * Conversion CTA
 *
 * Behavior:
 * - Hidden by default
 * - Fades in when audio reaches 70% OR ends
 * - Delay 300-500ms after trigger for calm transition
 * - Routes to app store based on platform detection
 * - Desktop/unknown → /download page
 *
 * This is the ONLY CTA that routes off-site.
 */
---

<div
  id="conversion-cta"
  class="opacity-0 invisible translate-y-4 transition-all duration-700 ease-out"
  aria-hidden="true"
>
  <!-- Invitation text - soft, not pushy -->
  <p class="text-cream-200 text-center mb-6 text-base md:text-lg font-light">
    If that felt helpful, you can continue in the app.
  </p>

  <!-- Conversion button - full width on mobile -->
  <button
    id="store-cta"
    type="button"
    class="w-full md:w-auto px-8 py-4 bg-accent hover:bg-accent-light text-cream-100 font-medium rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-accent/50 focus:ring-offset-2 focus:ring-offset-dark-900"
  >
    Continue with a free 3-day trial
  </button>
</div>

<script>
  const conversionCta = document.getElementById('conversion-cta');
  const storeBtn = document.getElementById('store-cta');
  let ctaRevealed = false;

  /**
   * Platform Detection
   * - iOS → Apple App Store
   * - Android → Google Play Store
   * - Desktop/Unknown → /download page
   */
  function detectPlatform(): 'ios' | 'android' | 'desktop' {
    const ua = navigator.userAgent || navigator.vendor || '';

    // iOS detection (iPhone, iPad, iPod)
    if (/iPad|iPhone|iPod/.test(ua) && !(window as any).MSStream) {
      return 'ios';
    }

    // Android detection
    if (/android/i.test(ua)) {
      return 'android';
    }

    // Desktop or unknown
    return 'desktop';
  }

  /**
   * Get store URL based on platform
   * Replace these with actual App Store URLs
   */
  function getStoreUrl(): string {
    const platform = detectPlatform();

    switch (platform) {
      case 'ios':
        return 'https://apps.apple.com/us/app/mesmer-ai-hypnosis-sleep/id6752903286';
      case 'android':
        return 'https://play.google.com/store/apps/details?id=com.mesmerhypnosis.ambitiousdesignlab';
      default:
        // Desktop or unknown → fallback page
        return '/download';
    }
  }

  /**
   * Reveal CTA with calm transition
   * - 400ms delay after trigger
   * - Opacity + subtle translateY animation
   */
  function revealCta() {
    if (ctaRevealed) return;
    ctaRevealed = true;

    // Delay for calm transition
    setTimeout(() => {
      if (conversionCta) {
        conversionCta.classList.remove('opacity-0', 'invisible', 'translate-y-4');
        conversionCta.classList.add('opacity-100', 'visible', 'translate-y-0');
        conversionCta.setAttribute('aria-hidden', 'false');
      }
    }, 400);
  }

  // Trigger CTA reveal at 70% audio progress
  window.addEventListener('audioProgress70', revealCta);

  // Also trigger on audio end (fallback)
  window.addEventListener('audioEnded', revealCta);

  // Handle store button click with platform detection
  storeBtn?.addEventListener('click', () => {
    const url = getStoreUrl();
    const platform = detectPlatform();

    // Analytics hook: store redirect click
    console.log(`[Analytics] Store redirect: ${platform} → ${url}`);

    // Redirect to appropriate store
    window.location.href = url;
  });
</script>
